
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essentie Tool — Sessies</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="wrap">
    <h1>Essentie Tool — Login & Sessies</h1>

    <div class="card">
      <h2>Inloggen</h2>
      <div class="row">
        <input id="email" type="email" placeholder="jij@voorbeeld.nl" />
        <button id="send">Stuur magic link</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="logout">Uitloggen</button>
        <span id="who" class="muted"></span>
      </div>
      <div id="status" class="status muted"></div>
      <div class="muted">Na klikken op de link in je e‑mail, keer terug naar deze pagina en ververs.</div>
    </div>

    <div class="card">
      <h2>Nieuwe sessie</h2>
      <div class="row">
        <input id="sessionTitle" type="text" placeholder="Titel (bv. Eerste test)" />
        <button id="makeSession">Maak sessie</button>
      </div>
      <div id="sessionStatus" class="status muted"></div>
      <ul id="sessionsList" class="muted" style="margin-top:10px"></ul>
    </div>
  </div>

  <script type="module">
    import {{ supabase }} from "./supabaseClient.js"

    const email = document.getElementById('email')
    const send = document.getElementById('send')
    const logout = document.getElementById('logout')
    const who = document.getElementById('who')
    const status = document.getElementById('status')

    const sessionTitle = document.getElementById('sessionTitle')
    const makeSession = document.getElementById('makeSession')
    const sessionStatus = document.getElementById('sessionStatus')
    const sessionsList = document.getElementById('sessionsList')

    function setStatus(msg) {{ status.textContent = msg || '' }}
    function s(msg) {{ sessionStatus.textContent = msg || '' }}

    async function refreshUser() {{
      const {{ data: {{ user }} }} = await supabase.auth.getUser()
      who.textContent = user?.email ? `Ingelogd als ${{user.email}}` : ''
    }}

    send.onclick = async () => {{
      const v = (email.value || '').trim()
      if (!v) {{ setStatus('Vul je e‑mail in'); return }}
      const {{ error }} = await supabase.auth.signInWithOtp({{
        email: v,
        options: {{ emailRedirectTo: window.location.origin }}
      }})
      if (error) setStatus(error.message)
      else setStatus('Magic link verzonden. Check je e‑mail ✉️')
    }}

    logout.onclick = async () => {{
      await supabase.auth.signOut()
      await refreshUser()
      setStatus('Uitgelogd')
    }}

    supabase.auth.onAuthStateChange(() => {{ refreshUser(); listSessions(); }})
    refreshUser()

    async function getDefaultSetId() {{
      const {{ data, error }} = await supabase
        .from('question_sets')
        .select('id')
        .eq('is_default', true)
        .single()
      if (error) throw error
      return data.id
    }}

    async function listSessions() {{
      const {{ data: {{ user }} }} = await supabase.auth.getUser()
      if (!user) {{ sessionsList.innerHTML = ''; return }}
      const {{ data, error }} = await supabase
        .from('sessions')
        .select('id,title,created_at')
        .eq('user_id', user.id)
        .order('created_at', {{ ascending: false }})
      if (error) {{ s(error.message); return }}
      sessionsList.innerHTML = (data || [])
        .map(row => `<li>${{row.title || '(zonder titel)'}} — <code>${{row.id}}</code> — <a href="./vragen.html?session=${{row.id}}">Start vragen</a></li>`)
        .join('')
    }}

    makeSession.onclick = async () => {{
      try {{
        s('Bezig…')
        const {{ data: {{ user }} }} = await supabase.auth.getUser()
        if (!user) {{ s('Log eerst in.'); return }}
        const setId = await getDefaultSetId()
        const title = (sessionTitle.value || '').trim() || 'Nieuwe sessie'
        const {{ error }} = await supabase.from('sessions').insert({{
          user_id: user.id,
          set_id: setId,
          title
        }})
        if (error) throw error
        sessionTitle.value = ''
        s('Sessie aangemaakt ✅')
        listSessions()
      }} catch (e) {{
        s('Fout: ' + (e.message || e))
      }}
    }}

    listSessions()
  </script>
</body>
</html>
