<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Essentie Tool — Login & Sessies</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; }
    .card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .row { display: flex; gap: 8px; }
    input { flex: 1; padding: 8px; }
    button { padding: 8px 12px; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <h1>Essentie Tool — Login & Sessies</h1>

  <div class="card">
    <h2>Inloggen</h2>
    <div class="row">
      <input id="email" type="email" placeholder="jij@voorbeeld.nl" />
      <button id="send">Stuur magic link</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="logout">Uitloggen</button>
      <span id="who" style="margin-left:8px; opacity:0.7"></span>
    </div>
    <div id="status" style="margin-top:8px; opacity:0.7"></div>
  </div>

  <div class="card">
    <h2>Nieuwe sessie</h2>
    <div class="row">
      <input id="sessionTitle" type="text" placeholder="Titel (bv. Eerste test)" />
      <button id="makeSession">Maak sessie</button>
    </div>
    <div id="sessionStatus" style="margin-top:8px; opacity:0.7"></div>
    <ul id="sessionsList" style="margin-top:10px; opacity:0.7"></ul>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4"
    const supabase = createClient("https://lhubynidwlzpsdqrpavs.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxodWJ5bmlkd2x6cHNkcXJwYXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTA2MjAsImV4cCI6MjA3MDU4NjYyMH0.KXCgqZ4-IQJoVc9SAUyI189BBxAcW5maxkUdHG7bmeM", {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    })

    const email = document.getElementById('email')
    const send = document.getElementById('send')
    const logout = document.getElementById('logout')
    const who = document.getElementById('who')
    const status = document.getElementById('status')

    const sessionTitle = document.getElementById('sessionTitle')
    const makeSession = document.getElementById('makeSession')
    const sessionStatus = document.getElementById('sessionStatus')
    const sessionsList = document.getElementById('sessionsList')

    function setStatus(msg) { status.textContent = msg || '' }
    function s(msg) { sessionStatus.textContent = msg || '' }

    async function refreshUser() {
      const { data: { user } } = await supabase.auth.getUser()
      who.textContent = user?.email ? `Ingelogd als ${user.email}` : ''
    }

    send.onclick = async () => {
      const v = (email.value || '').trim()
      if (!v) return setStatus('Vul je e‑mail in')
      const { error } = await supabase.auth.signInWithOtp({
        email: v,
        options: { emailRedirectTo: window.location.origin }
      })
      if (error) setStatus(error.message)
      else setStatus('Magic link verzonden. Check je e‑mail ✉️')
    }

    logout.onclick = async () => {
      await supabase.auth.signOut()
      await refreshUser()
      setStatus('Uitgelogd')
    }

    supabase.auth.onAuthStateChange(() => { refreshUser(); listSessions(); })
    refreshUser()

    async function getDefaultSetId() {
      const { data, error } = await supabase
        .from('question_sets')
        .select('id')
        .eq('is_default', true)
        .single()
      if (error) throw error
      return data.id
    }

    async function listSessions() {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) { sessionsList.innerHTML = ''; return }
      const { data, error } = await supabase
        .from('sessions')
        .select('id,title,created_at')
        .order('created_at', { ascending: false })
      if (error) { s(error.message); return }
      sessionsList.innerHTML = (data || [])
        .map(row => `<li>${row.title || '(zonder titel)'} — <code>${row.id}</code></li>`)
        .join('')
    }

    makeSession.onclick = async () => {
      try {
        s('Bezig…')
        const { data: { user } } = await supabase.auth.getUser()
        if (!user) return s('Log eerst in.')
        const setId = await getDefaultSetId()
        const title = (sessionTitle.value || '').trim() || 'Nieuwe sessie'
        const { error } = await supabase.from('sessions').insert({
          user_id: user.id,
          set_id: setId,
          title
        })
        if (error) throw error
        sessionTitle.value = ''
        s('Sessie aangemaakt ✅')
        listSessions()
      } catch (e) {
        s('Fout: ' + (e.message || e))
      }
    }

    listSessions()
  </script>
</body>
</html>
